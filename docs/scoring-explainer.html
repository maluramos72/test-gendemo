<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simulador Quality Scorer â€” QA Test GenDemo</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=DM+Sans:wght@400;500;600;700&display=swap');

  :root {
    --bg:      #020c1b;
    --surface: #080e1a;
    --s2:      #0a1628;
    --border:  #0e1e35;
    --border2: #162640;
    --text:    #e2e8f0;
    --muted:   #3d5470;
    --muted2:  #253a56;

    --c-qty:   #3b82f6;
    --c-steps: #06b6d4;
    --c-prec:  #8b5cf6;
    --c-res:   #f59e0b;
    --c-div:   #22c55e;

    --green: #22c55e;
    --amber: #f59e0b;
    --red:   #ef4444;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    padding: 40px 24px 64px;
  }

  /* â”€â”€ Header â”€â”€ */
  .header { margin-bottom: 28px; }
  .header-badge {
    display: inline-flex; align-items: center; gap: 8px;
    background: var(--s2); border: 1px solid var(--border2);
    border-radius: 20px; padding: 4px 14px; margin-bottom: 14px;
  }
  .badge-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--green); box-shadow: 0 0 7px var(--green); }
  .badge-text { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); letter-spacing: 0.1em; }
  .header h1 { font-size: 24px; font-weight: 700; letter-spacing: -0.025em; margin-bottom: 6px; }
  .header p  { font-size: 12px; color: var(--muted); font-family: 'DM Mono', monospace; }
  .header p span { color: var(--green); }

  /* â”€â”€ Preset tabs â”€â”€ */
  .tabs {
    display: flex; gap: 4px;
    background: var(--surface); border-radius: 10px;
    padding: 4px; width: fit-content; margin-bottom: 24px;
  }
  .tab {
    padding: 7px 18px; border-radius: 7px; border: none;
    font-family: 'DM Sans', sans-serif; font-size: 12px;
    cursor: pointer; transition: all 0.15s; font-weight: 500;
  }

  /* â”€â”€ Main grid â”€â”€ */
  .main-grid { display: grid; grid-template-columns: 1fr 164px; gap: 18px; align-items: start; }

  /* â”€â”€ Dimension table â”€â”€ */
  .dim-table { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; }

  .dim-thead {
    display: grid; grid-template-columns: 28px 1fr 56px 90px 64px;
    padding: 9px 18px; background: var(--s2); border-bottom: 1px solid var(--border);
  }
  .th { font-family: 'DM Mono', monospace; font-size: 9px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.1em; }
  .th-right { text-align: center; }

  .dim-row { border-bottom: 1px solid var(--border); }
  .dim-row:last-child { border-bottom: none; }

  .dim-main {
    display: grid; grid-template-columns: 28px 1fr 56px 90px 64px;
    padding: 13px 18px; align-items: center;
  }
  .dim-accent { width: 3px; height: 28px; border-radius: 2px; opacity: 0.75; }

  .dim-info { padding-right: 12px; }
  .dim-name { font-size: 13px; font-weight: 600; color: var(--text); margin-bottom: 2px; }
  .dim-formula { font-family: 'DM Mono', monospace; font-size: 9px; color: var(--muted); margin-bottom: 3px; }

  .bar-bg { height: 5px; background: #0f172a; border-radius: 3px; overflow: hidden; }
  .bar-fill { height: 100%; border-radius: 3px; transition: width 0.8s cubic-bezier(.4,0,.2,1); }

  .dim-peso { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--muted); text-align: center; }
  .dim-campo-wrap { text-align: center; }
  .dim-campo {
    font-family: 'DM Mono', monospace; font-size: 9px; padding: 2px 5px;
    border-radius: 4px; background: #0f172a; color: var(--muted); border: 1px solid var(--border);
    display: inline-block;
  }
  .dim-val { font-family: 'DM Mono', monospace; font-size: 14px; font-weight: 700; text-align: center; transition: color 0.3s; }

  .dim-sub { padding: 0 18px 10px 46px; display: flex; justify-content: space-between; align-items: center; }
  .dim-penalty { font-size: 10px; color: var(--muted2); }
  .dim-contrib { font-family: 'DM Mono', monospace; font-size: 10px; }

  /* total row */
  .dim-total {
    padding: 12px 18px; background: var(--s2);
    display: flex; justify-content: space-between; align-items: center;
  }
  .total-formula { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); }
  .total-val { font-family: 'DM Mono', monospace; font-size: 15px; font-weight: 800; }

  /* â”€â”€ Score ring (SVG) â”€â”€ */
  .ring-wrap { display: flex; flex-direction: column; align-items: center; gap: 10px; }
  .ring-label { font-size: 13px; font-weight: 700; letter-spacing: 0.05em; }
  .ring-thresholds { display: flex; gap: 5px; flex-wrap: wrap; justify-content: center; }
  .ring-th {
    font-family: 'DM Mono', monospace; font-size: 9px;
    padding: 2px 6px; border-radius: 4px; border: 1px solid;
  }

  /* â”€â”€ Formula strip â”€â”€ */
  .formula-strip {
    margin-top: 16px; background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; padding: 13px 18px; font-family: 'DM Mono', monospace;
    font-size: 11px; overflow-x: auto; white-space: nowrap;
  }

  /* â”€â”€ Why note â”€â”€ */
  .why-note {
    margin-top: 14px; background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; padding: 13px 18px; display: flex; gap: 12px; align-items: flex-start;
  }
  .why-icon { font-size: 18px; flex-shrink: 0; }
  .why-text { font-size: 12px; color: var(--muted); line-height: 1.65; }
  .why-text b { color: var(--text); font-weight: 600; }
  .why-text .hl { color: var(--green); }

  @keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }
  .fade { animation: fadeIn 0.22s ease; }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-badge">
    <div class="badge-dot"></div>
    <span class="badge-text">services/scorer.py Â· 5 dimensiones</span>
  </div>
  <h1>Simulador Quality Scorer</h1>    
  <p>Simulador interactivo del <span>quality_score</span> que se muestra en el dashboard de resultados.</p>
</div>

<!-- Preset tabs -->
<div class="tabs" id="tabs"></div>

<!-- Main -->
<div class="main-grid">
  <div class="dim-table">
    <div class="dim-thead">
      <div class="th"></div>
      <div class="th">DimensiÃ³n</div>
      <div class="th th-right">Peso</div>
      <div class="th th-right">Campo JSON</div>
      <div class="th th-right">Valor</div>
    </div>
    <div id="dim-rows"></div>
    <div class="dim-total">
      <div class="total-formula" id="total-formula"></div>
      <div class="total-val" id="total-val"></div>
    </div>
  </div>

  <!-- Ring -->
  <div class="ring-wrap">
    <svg id="ring-svg" width="136" height="136" style="transform:rotate(-90deg)">
      <circle id="ring-track" cx="68" cy="68" r="54" fill="none" stroke="#0f172a" stroke-width="7"/>
      <circle id="ring-fill"  cx="68" cy="68" r="54" fill="none" stroke="#22c55e" stroke-width="7"
        stroke-dasharray="339.29" stroke-dashoffset="339.29" stroke-linecap="round"
        style="transition:stroke-dashoffset .8s cubic-bezier(.4,0,.2,1),stroke .3s"/>
      <text id="ring-num" x="68" y="68" text-anchor="middle" dominant-baseline="central"
        style="fill:#22c55e;font-size:24px;font-weight:800;font-family:'DM Mono',monospace;
               transform:rotate(90deg);transform-origin:68px 68px">0.00</text>
    </svg>
    <div class="ring-label" id="ring-label">â€”</div>
    <div class="ring-thresholds">
      <div class="ring-th" style="background:#22c55e15;color:#22c55e;border-color:#22c55e30">â‰¥0.75</div>
      <div class="ring-th" style="background:#f59e0b15;color:#f59e0b;border-color:#f59e0b30">â‰¥0.50</div>
      <div class="ring-th" style="background:#ef444415;color:#ef4444;border-color:#ef444430">&lt;0.50</div>
    </div>
  </div>
</div>

<!-- Formula strip -->
<div class="formula-strip" id="formula-strip"></div>

<!-- Why note -->
<div class="why-note">
  <span class="why-icon">ðŸ’¡</span>
  <div class="why-text">
    <b>Â¿Por quÃ© heurÃ­stico y no un segundo LLM?</b> Un segundo prompt de autoevaluaciÃ³n aÃ±adirÃ­a ~$0.0005 y ~2â€“3s de latencia por request.
    Las 5 heurÃ­sticas capturan el <span class="hl">80% de los casos problemÃ¡ticos</span> (resultados vagos, pasos faltantes, precondiciones genÃ©ricas)
    a costo cero. El score es una seÃ±al para el equipo consumidor, no un bloqueante duro para el usuario.
  </div>
</div>

<script>
// â”€â”€ Data 
const DIMS = [
  { key:"qty",   nombre:"Quality",              peso:0.20, campo:"nÂ° de casos",     formula:"min(n / 3, 1.0)",          penaliza:"< 3 casos generados",               color:"var(--c-qty)"   },
  { key:"steps", nombre:"Steps_depth",          peso:0.25, campo:"steps[ ]",        formula:"avg(min(pasos/3, 1.0))",   penaliza:"1 pasoâ†’0.33 Â· 2â†’0.67 Â· 3+â†’1.0",    color:"var(--c-steps)" },
  { key:"prec",  nombre:"Preconditions",        peso:0.20, campo:"preconditions",   formula:"regex genÃ©rica + len>20",  penaliza:'"the user is logged in" â†’ 0.2',     color:"var(--c-prec)"  },
  { key:"res",   nombre:"Expected_results",     peso:0.20, campo:"expected_result", formula:"count(palabras vagas)",    penaliza:'"works", "ok", "correct" â†’ penaliz.',color:"var(--c-res)"   },
  { key:"div",   nombre:"Diversity",            peso:0.15, campo:"title (todos)",   formula:"min(words / nÃ—3, 1.0)",    penaliza:"TÃ­tulos repetitivos o genÃ©ricos",    color:"var(--c-div)"   },
];

const PRESETS = {
  perfecto: {
    label:"âœ¦ Alta calidad", color:"#22c55e",
    cases:[
      { title:"Happy path: enlace de recuperaciÃ³n enviado",
        preconditions:"Usuario registrado con email 'qa@example.com' y cuenta verificada en la base de datos.",
        steps:["Navegar a /login","Clic en 'OlvidÃ© mi contraseÃ±a'","Ingresar 'qa@example.com'","Clic en 'Enviar enlace'"],
        expected_result:"Sistema envÃ­a correo y muestra: 'Revisa tu bandeja â€” recibirÃ¡s el enlace en minutos.'" },
      { title:"Error: email no registrado devuelve mensaje genÃ©rico",
        preconditions:"El email 'noexiste@test.com' no existe en ninguna cuenta del sistema.",
        steps:["Ir a /forgot-password","Ingresar 'noexiste@test.com'","Clic en 'Enviar enlace'"],
        expected_result:"Sistema muestra: 'Si este email existe, recibirÃ¡s un enlace.' Sin revelar si la cuenta existe." },
      { title:"Seguridad: token expirado rechaza el cambio",
        preconditions:"Token de recuperaciÃ³n emitido hace mÃ¡s de 24 horas para 'qa@example.com'.",
        steps:["Abrir correo de recuperaciÃ³n antiguo","Clic en el enlace","Intentar ingresar nueva contraseÃ±a"],
        expected_result:"Sistema retorna HTTP 401 y muestra: 'Este enlace expirÃ³. Solicita uno nuevo.' Sin cambios de contraseÃ±a." },
      { title:"Borde: solicitar recuperaciÃ³n dos veces en 5 minutos",
        preconditions:"Usuario solicitÃ³ enlace hace 3 minutos y no lo ha usado aÃºn.",
        steps:["Ir a /forgot-password","Ingresar el mismo email","Clic en enviar nuevamente"],
        expected_result:"Sistema invalida token anterior y emite uno nuevo, o bloquea por rate-limit. Muestra mensaje de confirmaciÃ³n." },
    ],
  },
  medio: {
    label:"â—ˆ Calidad media", color:"#f59e0b",
    cases:[
      { title:"Test de login",
        preconditions:"El usuario estÃ¡ en la app.",
        steps:["Abrir app","Ingresar datos"],
        expected_result:"El sistema funciona correctamente y el usuario accede bien." },
      { title:"Test de error con email",
        preconditions:"Email incorrecto ingresado en el formulario de la aplicaciÃ³n.",
        steps:["Ingresar email incorrecto","Clic en enviar"],
        expected_result:"El sistema muestra un mensaje de error al usuario." },
    ],
  },
  malo: {
    label:"â—‹ Mejorable", color:"#ef4444",
    cases:[
      { title:"Test",
        preconditions:"N/A",
        steps:["Hacer algo"],
        expected_result:"OK" },
    ],
  },
};

// â”€â”€ Scoring logic (mirrors scorer.py) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const VAGUE   = /\b(works|correct(ly)?|properly|fine|good|ok|okay|done|success|funciona|correcto|bien)\b/i;
const GENERIC = /^(the user is (logged in|on the app|in the system)|n\/?a|none|ninguna?|el usuario estÃ¡ en la app)$/i;

function scoreCase(tc) {
  const steps = Math.min(tc.steps.length / 3, 1.0);
  const prec  = GENERIC.test(tc.preconditions.trim()) ? 0.2 : tc.preconditions.length > 20 ? 1.0 : 0.6;
  const vN    = (tc.expected_result.match(VAGUE) || []).length;
  const res   = vN === 0 && tc.expected_result.length > 30 ? 1.0 : vN <= 1 ? 0.7 : 0.3;
  return { steps, prec, res };
}

function computeScore(cases) {
  const n     = cases.length;
  const qty   = Math.min(n / 3, 1.0);
  const pc    = cases.map(scoreCase);
  const steps = pc.reduce((a,b) => a+b.steps,0) / n;
  const prec  = pc.reduce((a,b) => a+b.prec, 0) / n;
  const res   = pc.reduce((a,b) => a+b.res,  0) / n;
  const words = new Set(cases.flatMap(tc => tc.title.toLowerCase().split(/\s+/)));
  const div   = Math.min(words.size / (n * 3), 1.0);
  const dims  = { qty, steps, prec, res, div };
  const W     = { qty:0.20, steps:0.25, prec:0.20, res:0.20, div:0.15 };
  const contrib = {};
  let total = 0;
  for (const k in dims) { contrib[k] = dims[k] * W[k]; total += contrib[k]; }
  return { dims, contrib, total: Math.round(total * 1000) / 1000, W };
}

// â”€â”€ Color helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scoreColor(v) { return v >= 0.75 ? '#22c55e' : v >= 0.5 ? '#f59e0b' : '#ef4444'; }

// â”€â”€ Animated counter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function animateTo(el, target, decimals=2, duration=700, isSvgText=false) {
  const start = performance.now();
  const step = now => {
    const p = Math.min((now - start) / duration, 1);
    const eased = 1 - Math.pow(1 - p, 3);
    const val = (target * eased).toFixed(decimals);
    if (isSvgText) el.textContent = val;
    else el.textContent = val;
    if (p < 1) requestAnimationFrame(step);
  };
  requestAnimationFrame(step);
}

// â”€â”€ Animated bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function animateBar(el, targetPct) {
  el.style.width = '0%';
  setTimeout(() => { el.style.width = targetPct + '%'; }, 60);
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let activePreset = 'perfecto';

function render(presetKey) {
  activePreset = presetKey;
  const preset = PRESETS[presetKey];
  const { dims, contrib, total } = computeScore(preset.cases);

  // â”€â”€ Tabs â”€â”€
  const tabsEl = document.getElementById('tabs');
  tabsEl.innerHTML = '';
  Object.entries(PRESETS).forEach(([key, p]) => {
    const btn = document.createElement('button');
    btn.className = 'tab';
    btn.textContent = p.label;
    const isActive = key === presetKey;
    btn.style.background    = isActive ? p.color + '22' : 'transparent';
    btn.style.color         = isActive ? p.color : 'var(--muted)';
    btn.style.fontWeight    = isActive ? '700' : '400';
    btn.addEventListener('click', () => render(key));
    tabsEl.appendChild(btn);
  });

  // â”€â”€ Dimension rows â”€â”€
  const rowsEl = document.getElementById('dim-rows');
  rowsEl.innerHTML = '';
  rowsEl.classList.remove('fade');
  void rowsEl.offsetWidth;
  rowsEl.classList.add('fade');

  DIMS.forEach(d => {
    const val  = dims[d.key] ?? 0;
    const clr  = scoreColor(val);
    const bar  = Math.round(val * 100);
    const cont = (contrib[d.key] ?? 0).toFixed(3);

    const row = document.createElement('div');
    row.className = 'dim-row';
    row.innerHTML = `
      <div class="dim-main">
        <div class="dim-accent" style="background:${d.color}"></div>
        <div class="dim-info">
          <div class="dim-name">${d.nombre}</div>
          <div class="dim-formula">${d.formula}</div>
          <div class="bar-bg"><div class="bar-fill" id="bar-${d.key}" style="background:${clr};box-shadow:0 0 6px ${clr}55;width:0%"></div></div>
        </div>
        <div class="dim-peso">Ã—${d.peso}</div>
        <div class="dim-campo-wrap"><span class="dim-campo">${d.campo}</span></div>
        <div class="dim-val" id="val-${d.key}" style="color:${clr}">0.00</div>
      </div>
      <div class="dim-sub">
        <span class="dim-penalty">Penaliza: ${d.penaliza}</span>
        <span class="dim-contrib" style="color:${clr}">${val.toFixed(3)} Ã— ${d.peso} = <b>${cont}</b></span>
      </div>
    `;
    rowsEl.appendChild(row);

    // Animate
    animateTo(document.getElementById(`val-${d.key}`), val);
    animateBar(document.getElementById(`bar-${d.key}`), bar);
  });

  // â”€â”€ Total row â”€â”€
  const totalColor = scoreColor(total);
  document.getElementById('total-formula').textContent =
    DIMS.map(d => `${(dims[d.key]??0).toFixed(2)}Ã—${d.peso}`).join(' + ');
  const totalEl = document.getElementById('total-val');
  totalEl.style.color = totalColor;
  animateTo(totalEl, total, 3);

  // â”€â”€ Ring â”€â”€
  const CIRC = 2 * Math.PI * 54;
  const ringFill  = document.getElementById('ring-fill');
  const ringNum   = document.getElementById('ring-num');
  const ringLabel = document.getElementById('ring-label');
  const label     = total >= 0.75 ? 'Alta calidad' : total >= 0.5 ? 'Calidad media' : 'Mejorable';

  ringFill.style.stroke          = totalColor;
  ringFill.style.strokeDashoffset = CIRC * (1 - total);
  ringNum.style.fill              = totalColor;
  ringLabel.style.color           = totalColor;
  ringLabel.textContent           = label;
  animateTo(ringNum, total, 2, 700, true);

  // â”€â”€ Formula strip â”€â”€
  const strip = document.getElementById('formula-strip');
  strip.innerHTML = `<span style="color:var(--muted2)">quality_score = </span>`;
  DIMS.forEach((d, i) => {
    const val  = dims[d.key] ?? 0;
    const clr  = scoreColor(val);
    const cont = (contrib[d.key] ?? 0).toFixed(3);
    strip.innerHTML +=
      `<span style="color:${clr}">(${val.toFixed(2)}Ã—${d.peso})</span>` +
      `<span style="color:var(--green);font-size:9px">[${cont}]</span>` +
      (i < DIMS.length - 1 ? `<span style="color:var(--muted2)"> + </span>` : '');
  });
  strip.innerHTML +=
    `<span style="color:var(--muted2)"> = </span>` +
    `<span style="color:${totalColor};font-weight:800;font-size:14px">${total.toFixed(3)}</span>`;
}

// Init
render('perfecto');
</script>
</body>
</html>
